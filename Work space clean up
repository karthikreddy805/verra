#!/bin/bash
 
# Configuration
REGION="us-east-1"
INACTIVITY_DAYS=30
NOW=$(date -u +%s)
 
# Convert date to timestamp
cutoff_date=$(date -u -d "-${INACTIVITY_DAYS} days" +%s)
 
echo "Fetching EMR Studios in region: $REGION..."
 
studio_ids=$(aws emr list-studios --region "$REGION" --output json | jq -r '.Studios[].StudioId')
 
for studio_id in $studio_ids; do
  echo "Checking workspaces in Studio: $studio_id"
 
  workspace_output=$(aws emr list-workspaces --region "$REGION" --studio-id "$studio_id" --output json)
 
  echo "$workspace_output" | jq -c '.Workspaces[]' | while read -r ws; do
    workspace_id=$(echo "$ws" | jq -r '.WorkspaceId')
    last_modified=$(echo "$ws" | jq -r '.LastModifiedTime')
 
    if [ "$last_modified" = "null" ]; then
      echo "Skipping workspace $workspace_id (no last modified time)"
      continue
    fi
 
    # Convert ISO time to epoch seconds
    last_modified_epoch=$(date -u -d "$last_modified" +%s)
 
    if [ "$last_modified_epoch" -lt "$cutoff_date" ]; then
      echo "Deleting unused workspace: $workspace_id (Last modified: $last_modified)"
      aws emr delete-workspace --region "$REGION" --studio-id "$studio_id" --workspace-id "$workspace_id"
    else
      echo "Skipping active workspace: $workspace_id (Last modified: $last_modified)"
    fi
  done
done
 
echo "Cleanup completed."
